<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pymochi.data &mdash; MoCHI  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            MoCHI
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">MoCHI API Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MoCHI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pymochi.data</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pymochi.data</h1><div class="highlight"><pre>
<span></span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">MoCHI data module</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="kn">import</span> <span class="nn">pyreadr</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pymochi.transformation</span> <span class="kn">import</span> <span class="n">get_transformation</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">collections</span><span class="o">,</span> <span class="nn">functools</span><span class="o">,</span> <span class="nn">operator</span>

<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getmembers</span><span class="p">,</span> <span class="n">isfunction</span>

<div class="viewcode-block" id="CustomTransformations">
<a class="viewcode-back" href="../../api.html#pymochi.data.CustomTransformations">[docs]</a>
<span class="k">class</span> <span class="nc">CustomTransformations</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for custom transformations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">code_string</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a CustomTransformations object.</span>

<span class="sd">        :param code_string: code string (required).</span>
<span class="sd">        :returns: CustomTransformations object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Import code as module</span>
        <span class="n">temp_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_code</span><span class="p">(</span><span class="n">code_string</span><span class="p">)</span>
        <span class="c1">#Save functions in dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="n">temp_module</span><span class="p">)</span> <span class="k">if</span> <span class="n">isfunction</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span>
        <span class="c1">#Check functions valid</span>
        <span class="n">invalid_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_transformations</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">invalid_functions</span><span class="o">!=</span><span class="p">[]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid custom transformations: &quot;</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_functions</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>                  

<div class="viewcode-block" id="CustomTransformations.import_code">
<a class="viewcode-back" href="../../api.html#pymochi.data.CustomTransformations.import_code">[docs]</a>
    <span class="k">def</span> <span class="nf">import_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">code</span><span class="p">,</span> 
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;temp_module&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Import code as module.</span>

<span class="sd">        :param code: string code to import (required).</span>
<span class="sd">        :param name: module name (default:&#39;temp_module&#39;).</span>
<span class="sd">        :returns: imported module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Create blank module</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1">#Populate the module with code</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">module</span></div>


<div class="viewcode-block" id="CustomTransformations.check_transformations">
<a class="viewcode-back" href="../../api.html#pymochi.data.CustomTransformations.check_transformations">[docs]</a>
    <span class="k">def</span> <span class="nf">check_transformations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check custom transformations are valid functions.</span>

<span class="sd">        :returns: list of transformation names not satisfying mochi requirements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check dictionary returned when no input tensor supplied</span>
        <span class="n">bad_trans</span> <span class="o">=</span> <span class="p">[</span><span class="n">tname</span> <span class="k">for</span> <span class="n">tname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">[</span><span class="n">tname</span><span class="p">]())</span><span class="o">!=</span><span class="nb">dict</span><span class="p">]</span>
        <span class="c1">#Check tensor returned when list of tensors supplied</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bad_trans</span><span class="p">:</span>
                <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">[</span><span class="n">i</span><span class="p">]()</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
                <span class="n">bad_trans</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tname</span> <span class="k">for</span> <span class="n">tname</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformations</span><span class="p">[</span><span class="n">i</span><span class="p">](</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> 
                    <span class="n">trainable_parameters</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">))</span><span class="o">!=</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">bad_trans</span></div>
</div>


<div class="viewcode-block" id="FitnessData">
<a class="viewcode-back" href="../../api.html#pymochi.data.FitnessData">[docs]</a>
<span class="k">class</span> <span class="nc">FitnessData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for the storage of fitness data from a single DMS experiment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">file_path</span><span class="p">,</span> 
        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">order_subset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">downsample_observations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a FitnessData object.</span>

<span class="sd">        :param file_path: path to input file (required).</span>
<span class="sd">        :param name: name of fitness dataset (optional).</span>
<span class="sd">        :param order_subset: list of mutation orders corresponding to retained variants (optional).</span>
<span class="sd">        :param downsample_observations: number (if integer) or proportion (if float) of observations to retain including WT (optional).</span>
<span class="sd">        :param seed: Random seed for downsampling observations (default:1).</span>
<span class="sd">        :returns: FitnessData object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Initialize attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequenceType</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#&quot;nucleotide&quot; or &quot;aminoacid&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variantCol</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#&quot;nt_seq&quot; or &quot;aa_seq&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutationOrderCol</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#&quot;Nham_nt&quot; or &quot;Nham_aa&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wildtype</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wildtype_split</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1">#list of characters</span>

        <span class="c1">#Read the indicated file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_fitness</span><span class="p">(</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="p">,</span> 
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> 
            <span class="n">order_subset</span> <span class="o">=</span> <span class="n">order_subset</span><span class="p">,</span>
            <span class="n">downsample_observations</span> <span class="o">=</span> <span class="n">downsample_observations</span><span class="p">,</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>

<div class="viewcode-block" id="FitnessData.read_fitness_r">
<a class="viewcode-back" href="../../api.html#pymochi.data.FitnessData.read_fitness_r">[docs]</a>
    <span class="k">def</span> <span class="nf">read_fitness_r</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read fitness from DiMSum RData file.</span>

<span class="sd">        :param file_path: path to RData file (required).</span>
<span class="sd">        :returns: pandas DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1">#Read file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vtable</span> <span class="o">=</span> <span class="n">pyreadr</span><span class="o">.</span><span class="n">read_r</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid RData fitness file: cannot read file.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Check variant fitness object exists</span>
        <span class="k">if</span> <span class="s1">&#39;all_variants&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vtable</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid RData fitness file: variant data not found.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;all_variants&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="FitnessData.read_fitness_txt">
<a class="viewcode-back" href="../../api.html#pymochi.data.FitnessData.read_fitness_txt">[docs]</a>
    <span class="k">def</span> <span class="nf">read_fitness_txt</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read fitness from plain text file.</span>

<span class="sd">        :param file_path: path to plain text file (required).</span>
<span class="sd">        :returns: pandas DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="c1">#Read file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">,</span> <span class="n">na_values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="n">keep_default_na</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid plain text fitness file: cannot read file.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="n">vtable</span></div>


<div class="viewcode-block" id="FitnessData.read_fitness">
<a class="viewcode-back" href="../../api.html#pymochi.data.FitnessData.read_fitness">[docs]</a>
    <span class="k">def</span> <span class="nf">read_fitness</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">file_path</span><span class="p">,</span> 
        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">order_subset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">downsample_observations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read fitness from DiMSum file.</span>

<span class="sd">        :param file_path: path to file (required).</span>
<span class="sd">        :param name: name of fitness dataset (optional).</span>
<span class="sd">        :param order_subset: list of mutation orders corresponding to retained variants (optional).</span>
<span class="sd">        :param downsample_observations: number (if integer) or proportion (if float) of observations to retain including WT (optional).</span>
<span class="sd">        :param seed: Random seed for downsampling observations (default:1).</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Check file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Fitness file not found.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1">#Automatically detect file type</span>
        <span class="n">file_type</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">nrows</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">file_type</span> <span class="o">=</span> <span class="s2">&quot;RData&quot;</span>

        <span class="c1">#Convert downsample_observations to integer if round number</span>
        <span class="k">if</span> <span class="n">downsample_observations</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">downsample_observations</span><span class="o">%</span><span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">downsample_observations</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">downsample_observations</span><span class="p">)</span>

        <span class="c1">#Read file</span>
        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;RData&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fitness_r</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_type</span> <span class="o">==</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_fitness_txt</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1">#Check if data exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1">#Nucleotide or peptide sequence?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sequenceType</span> <span class="o">=</span> <span class="s2">&quot;nucleotide&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variantCol</span> <span class="o">=</span> <span class="s2">&quot;nt_seq&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutationOrderCol</span> <span class="o">=</span> <span class="s2">&quot;Nham_nt&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;aa_seq&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sequenceType</span> <span class="o">=</span> <span class="s2">&quot;aminoacid&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variantCol</span> <span class="o">=</span> <span class="s2">&quot;aa_seq&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutationOrderCol</span> <span class="o">=</span> <span class="s2">&quot;Nham_aa&quot;</span>

        <span class="c1">#Check required columns exist</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variantCol</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">mutationOrderCol</span><span class="p">,</span> 
            <span class="s1">&#39;WT&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;fitness&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sigma&#39;</span><span class="p">]])</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid fitness data: required columns not found.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1">#Remove variants with STOP or STOP_readthrough (if columns present)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequenceType</span> <span class="o">==</span> <span class="s2">&quot;aminoacid&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;STOP&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;STOP&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;STOP_readthrough&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;STOP_readthrough&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span>

        <span class="c1">#Remove variants of undesired mutation order</span>
        <span class="k">if</span> <span class="n">order_subset</span><span class="o">!=</span><span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">order_subset</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">i</span> <span class="ow">in</span> <span class="n">order_subset</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mutationOrderCol</span><span class="p">]],:]</span>

        <span class="c1">#Check single WT variant present</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;WT&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span><span class="o">!=</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid fitness data: WT variant missing or ambiguous.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1">#Remove synonymous variants (if present)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;WT&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mutationOrderCol</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)]</span>

        <span class="c1">#Wild-type sequence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wildtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;WT&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variantCol</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wildtype_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wildtype</span><span class="p">]</span>

        <span class="c1">#Name</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

        <span class="c1">#Randomly downsample observations</span>
        <span class="k">if</span> <span class="n">downsample_observations</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_observations</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                <span class="c1">#Downsample observations by proportion</span>
                <span class="k">if</span> <span class="n">downsample_observations</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">downsample_observations</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">vtable_wt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;WT&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">,:])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                        <span class="n">vtable_wt</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;WT&#39;</span><span class="p">]</span><span class="o">!=</span><span class="kc">True</span><span class="p">,:]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span> <span class="o">=</span> <span class="n">downsample_observations</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: downsample_observations argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_observations</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                <span class="c1">#Downsample observations by number</span>
                <span class="k">if</span> <span class="n">downsample_observations</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">vtable_wt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;WT&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">,:])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                        <span class="n">vtable_wt</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;WT&#39;</span><span class="p">]</span><span class="o">!=</span><span class="kc">True</span><span class="p">,:]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">downsample_observations</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: downsample_observations argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Length of object.</span>

<span class="sd">        :returns: Number of variants (length of vtable).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vtable</span><span class="p">)</span></div>


<div class="viewcode-block" id="MochiData">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData">[docs]</a>
<span class="k">class</span> <span class="nc">MochiData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for the storage of genotype-phenotype data from a collection of DMS experiments.</span>
<span class="sd">    An object of this class is required for model inference with MoCHI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="c1"># directory,</span>
        <span class="n">model_design</span><span class="p">,</span>
        <span class="n">order_subset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">downsample_observations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">downsample_interactions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_interaction_order</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">min_observed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">k_folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">validation_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> 
        <span class="n">holdout_minobs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> 
        <span class="n">holdout_orders</span> <span class="o">=</span> <span class="p">[],</span> 
        <span class="n">holdout_WT</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">ensemble</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">custom_transformations</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a MochiData object.</span>

<span class="sd">        # :param directory: Path to directory where data should be saved/loaded (required).</span>
<span class="sd">        :param model_design: Model design DataFrame with phenotype, transformation, trait and file columns (required).</span>
<span class="sd">        :param order_subset: list of mutation orders corresponding to retained variants (optional).</span>
<span class="sd">        :param downsample_observations: number (if integer) or proportion (if float) of observations to retain including WT (optional).</span>
<span class="sd">        :param downsample_interactions: number (if integer) or proportion (if float) or list of integer numbers (if string) of interaction terms to retain (optional).</span>
<span class="sd">        :param max_interaction_order: Maximum interaction order (default:1).</span>
<span class="sd">        :param min_observed: Minimum number of observations required to include interaction term (default:2).</span>
<span class="sd">        :param k_folds: Numbef of cross-validation folds (default:10).</span>
<span class="sd">        :param seed: Random seed for downsampling (observations and interactions) and defining cross-validation groups (default:1).</span>
<span class="sd">        :param validation_factor: Relative size of validation set with respect to test set (default:2).</span>
<span class="sd">        :param holdout_minobs: Minimum number of observations of additive trait weights to be held out (default:0).</span>
<span class="sd">        :param holdout_orders: list of mutation orders corresponding to retained variants (default:[] i.e. variants of all mutation orders can be held out).</span>
<span class="sd">        :param holdout_WT: Whether or not to WT variant can be held out (default:False).</span>
<span class="sd">        :param features: dictionary of trait-specific feature names to fit (default:{} i.e. all features fit).</span>
<span class="sd">        :param ensemble: Ensemble encode features. (default:False).</span>
<span class="sd">        :param custom_transformations: Path to custom transformations file (optional).</span>
<span class="sd">        :returns: MochiData object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Save attributes</span>
        <span class="c1"># self.directory = directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_design</span> <span class="o">=</span> <span class="n">model_design</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">order_subset</span> <span class="o">=</span> <span class="n">order_subset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downsample_observations</span> <span class="o">=</span> <span class="n">downsample_observations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">downsample_interactions</span> <span class="o">=</span> <span class="n">downsample_interactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_interaction_order</span> <span class="o">=</span> <span class="n">max_interaction_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_observed</span> <span class="o">=</span> <span class="n">min_observed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_folds</span> <span class="o">=</span> <span class="n">k_folds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_factor</span> <span class="o">=</span> <span class="n">validation_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holdout_minobs</span> <span class="o">=</span> <span class="n">holdout_minobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holdout_orders</span> <span class="o">=</span> <span class="n">holdout_orders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holdout_WT</span> <span class="o">=</span> <span class="n">holdout_WT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features_trait</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">ensemble</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations</span> <span class="o">=</span> <span class="n">custom_transformations</span>
        <span class="c1">#Initialize attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phenotype_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_userspec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations_code</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># #Create data directory</span>
        <span class="c1"># try:</span>
        <span class="c1">#     os.makedirs(self.directory)</span>
        <span class="c1"># except FileExistsError:</span>
        <span class="c1">#     print(&quot;Error: Data directory already exists.&quot;)</span>
        <span class="c1">#     raise ValueError</span>

        <span class="c1">#Check and save custom transformations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_custom_transformations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations</span><span class="p">)</span> 
        <span class="c1">#Check and save model design</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_design</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_model_design</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">)</span>
        <span class="c1">#Check features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_trait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_features</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
        <span class="c1">#Load all datasets</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading fitness data&quot;</span><span class="p">)</span>
        <span class="n">filepath_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>
        <span class="n">fdatalist</span> <span class="o">=</span> <span class="p">[</span><span class="n">FitnessData</span><span class="p">(</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">filepath_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">order_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order_subset</span><span class="p">,</span>
            <span class="n">downsample_observations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_observations</span><span class="p">,</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filepath_list</span><span class="p">))]</span>
        <span class="c1">#Merge all datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_datasets</span><span class="p">(</span><span class="n">fdatalist</span><span class="p">)</span>
        <span class="c1">#Fitness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;fitness&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">]]</span>
        <span class="c1">#Phenotypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_hot_encode_phenotypes</span><span class="p">()</span>
        <span class="c1">#Fitness weights</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="p">[</span><span class="s1">&#39;phenotype_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;phenotype&#39;</span><span class="p">])]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
        <span class="c1">#Sequence features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">variantCol</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#One hot encode sequence features</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One-hot encoding sequence features&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_hot_encode_features</span><span class="p">()</span>
        <span class="c1">#One-hot encode interaction features</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;One-hot encoding interaction features&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_hot_encode_interactions</span><span class="p">(</span>
            <span class="n">max_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_interaction_order</span><span class="p">,</span>
            <span class="n">min_observed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_observed</span><span class="p">,</span>
            <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span>
            <span class="n">downsample_interactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample_interactions</span><span class="p">,</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="c1"># self.one_hot_encode_interactions_todisk(</span>
        <span class="c1">#     max_order = self.max_interaction_order,</span>
        <span class="c1">#     min_observed = self.min_observed,</span>
        <span class="c1">#     features = self.features,</span>
        <span class="c1">#     downsample_interactions = self.downsample_interactions,</span>
        <span class="c1">#     seed = self.seed,</span>
        <span class="c1">#     holdout_minobs = self.holdout_minobs, </span>
        <span class="c1">#     holdout_orders = self.holdout_orders, </span>
        <span class="c1">#     holdout_WT = self.holdout_WT)</span>
        <span class="c1">#Split into training, validation and test sets</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Defining cross-validation groups&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_cross_validation_groups</span><span class="p">()</span>
        <span class="c1">#Define coefficients to fit (for each phenotype and trait)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Defining coefficient groups&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_coefficient_groups</span><span class="p">(</span>
            <span class="n">k_folds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_folds</span><span class="p">)</span>
        <span class="c1">#Ensemble encode features</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ensemble encoding features&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ensemble_encode_features</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done!&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="MochiData.check_custom_transformations">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.check_custom_transformations">[docs]</a>
    <span class="k">def</span> <span class="nf">check_custom_transformations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">input_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check custom transformations valid and reformat.</span>

<span class="sd">        :param input_obj: Path to custom transformations file or None (required).</span>
<span class="sd">        :returns: A reformatted custom transformations dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#No argument supplied</span>
        <span class="k">if</span> <span class="n">input_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="c1">#Object a string path</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">input_obj</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">input_obj</span><span class="p">)</span>
        <span class="c1">#Object not a path</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_obj</span><span class="p">)</span> <span class="o">!=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PosixPath</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: custom_transformations argument invalid.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Object does not exist or not a file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">input_obj</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">input_obj</span><span class="o">.</span><span class="n">is_file</span><span class="p">()):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Custom transformations file not found.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Read input file</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations_code</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">CustomTransformations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations_code</span><span class="p">)</span><span class="o">.</span><span class="n">transformations</span></div>


<div class="viewcode-block" id="MochiData.restore_custom_transformations">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.restore_custom_transformations">[docs]</a>
    <span class="k">def</span> <span class="nf">restore_custom_transformations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restore custom transformations and check valid and reformat.</span>

<span class="sd">        :returns: A reformatted custom transformations dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#For backwards compatibility supply all previous custom transformations code</span>
        <span class="k">if</span> <span class="s2">&quot;custom_transformations_code&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">input_obj</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;data/custom_transformations.py&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_obj</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations_code</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1">#Restore custom transformation from code</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations_code</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations</span> <span class="o">=</span> <span class="n">CustomTransformations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">custom_transformations_code</span><span class="p">)</span><span class="o">.</span><span class="n">transformations</span></div>


<div class="viewcode-block" id="MochiData.check_model_design">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.check_model_design">[docs]</a>
    <span class="k">def</span> <span class="nf">check_model_design</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">model_design</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check model design valid and reformat.</span>

<span class="sd">        :param model_design: Model design DataFrame with phenotype, transformation, trait and file columns (required).</span>
<span class="sd">        :returns: A reformatted model design DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Model design keys</span>
        <span class="n">model_design_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;phenotype&#39;</span><span class="p">,</span>
            <span class="s1">&#39;transformation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;trait&#39;</span><span class="p">,</span>
            <span class="s1">&#39;file&#39;</span><span class="p">,</span>
            <span class="s1">&#39;weight&#39;</span><span class="p">]</span>
        <span class="c1">#Check if model_design is a pandas DataFrame</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_design</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Model design is not a pandas DataFrame.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Add unity weights if not supplied</span>
        <span class="k">if</span> <span class="s1">&#39;weight&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_design</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1">#Check if all keys present</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_design</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model_design_keys</span><span class="p">])</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Model design missing required keys.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Split trait column items into list if necessary</span>
        <span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;trait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;trait&#39;</span><span class="p">]]</span>
        <span class="c1">#Unique traits</span>
        <span class="n">all_traits</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;trait&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="n">all_traits_unique</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="n">all_traits_unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_traits</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_traits_unique</span><span class="p">]</span>
        <span class="n">all_traits_unique_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">all_traits_unique</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_traits_unique</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
        <span class="c1">#Translate traits to integers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span> <span class="o">=</span> <span class="n">all_traits_unique</span>
        <span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;trait&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">all_traits_unique_dict</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;trait&#39;</span><span class="p">]]</span>
        <span class="c1">#Unique phenotypes</span>
        <span class="n">all_phenotypes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">])</span>
        <span class="n">all_phenotypes_unique</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="p">[</span><span class="n">all_phenotypes_unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_phenotypes</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_phenotypes_unique</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_phenotypes_unique</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_phenotypes</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Duplicated phenotype names.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Translate phenotypes to integers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phenotype_names</span> <span class="o">=</span> <span class="n">all_phenotypes_unique</span>
        <span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_design</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#Check phenotype names</span>
        <span class="n">forbidden_pnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nt_seq&#39;</span><span class="p">,</span> <span class="s1">&#39;aa_seq&#39;</span><span class="p">,</span> <span class="s1">&#39;Nham_nt&#39;</span><span class="p">,</span> <span class="s1">&#39;Nham_aa&#39;</span><span class="p">,</span> <span class="s1">&#39;WT&#39;</span><span class="p">,</span> <span class="s1">&#39;fitness&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;phenotype&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;ci95&#39;</span><span class="p">,</span> <span class="s1">&#39;Fold&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">([(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">forbidden_pnames</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;fold_&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phenotype_names</span><span class="p">])</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Forbidden phenotype names.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Check files not duplicated</span>
        <span class="n">all_files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_files</span><span class="p">))):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Duplicated fitness files.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">return</span> <span class="n">model_design</span></div>


<div class="viewcode-block" id="MochiData.check_features">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.check_features">[docs]</a>
    <span class="k">def</span> <span class="nf">check_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check features and reformat.</span>

<span class="sd">        :param features: features dictionary (required).</span>
<span class="sd">        :returns: A tuple of reformatted features (list) and features_trait (dictionary).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check dictionary</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">features</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;features&#39; argument is not a dictionary.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Filter applied to all traits (original input = list or single column of feature identifiers without header)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">key1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">#Filter applied to all traits</span>
                <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">elif</span> <span class="n">key1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">:</span>
                <span class="c1">#Filter applied to all traits</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FILTER APPLIED TO ALL TRAITS&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">)</span>
                <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">key1</span><span class="p">]</span><span class="o">+</span><span class="n">features</span><span class="p">[</span><span class="n">key1</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1">#Check all dictionary keys are trait names</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">])</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: One or more invalid trait names in &#39;features&#39; argument.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1">#Copy features dictionary</span>
        <span class="n">features_trait</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="c1">#List of unique features</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">features_trait</span><span class="p">)</span></div>


<div class="viewcode-block" id="MochiData.merge_datasets">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.merge_datasets">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_datasets</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge variant tables from a list of FitnessData objects with same WT and sequence type.</span>

<span class="sd">        :param data_list: list of FitnessData objects to merge (required).</span>
<span class="sd">        :returns: A merged FitnessData object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check if data to merge</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No Fitness datasets to merge.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Check if same WT and sequence type</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">wildtype</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">]))</span><span class="o">==</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">sequenceType</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">]))</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fdata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">vtable</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_list</span><span class="p">])</span>
            <span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fdata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Fitness datasets cannot be merged: WT variants do not match.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span></div>


<div class="viewcode-block" id="MochiData.one_hot_encode_phenotypes">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.one_hot_encode_phenotypes">[docs]</a>
    <span class="k">def</span> <span class="nf">one_hot_encode_phenotypes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1-hot encode phenotypes.</span>

<span class="sd">        :returns: A DataFrame with 1-hot phenotypes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_phenotypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">])]</span>
        <span class="n">phenotypes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_phenotypes</span><span class="p">:</span>
            <span class="n">phenotypes_df</span><span class="p">[</span><span class="s1">&#39;phenotype_&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="s1">&#39;phenotype&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phenotypes_df</span></div>


<div class="viewcode-block" id="MochiData.one_hot_encode_features">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.one_hot_encode_features">[docs]</a>
    <span class="k">def</span> <span class="nf">one_hot_encode_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">include_WT</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        1-hot encode sequences.</span>

<span class="sd">        :param include_WT: Whether or not to include WT feature (default:True).</span>
<span class="sd">        :returns: A DataFrame with 1-hot sequences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">enc</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span>
            <span class="n">handle_unknown</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> 
            <span class="n">drop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">wildtype_split</span><span class="p">),</span> 
            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">enc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
        <span class="n">one_hot_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">wildtype_split</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">enc</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()]</span>
        <span class="n">one_hot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">enc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">toarray</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">one_hot_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_WT</span><span class="p">:</span>
            <span class="n">one_hot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;WT&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">one_hot_df</span><span class="p">)}),</span> <span class="n">one_hot_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">one_hot_df</span></div>


<div class="viewcode-block" id="MochiData.get_theoretical_interactions_phenotype">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.get_theoretical_interactions_phenotype">[docs]</a>
    <span class="k">def</span> <span class="nf">get_theoretical_interactions_phenotype</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">phenotype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">max_order</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get theoretical interaction features for variants corresponding to a specific phenotype.</span>

<span class="sd">        :param phenotype: Phenotype number (default:1).</span>
<span class="sd">        :param max_order: Maximum interaction order (default:2).</span>
<span class="sd">        :returns: dictionary of interaction features.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Mutations observed for this phenotype</span>
        <span class="n">mut_count</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="p">[</span><span class="s1">&#39;phenotype_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">phenotype</span><span class="p">)]</span><span class="o">==</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">pheno_mut</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span> <span class="k">if</span> <span class="n">mut_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#All possible combinations of mutations</span>
        <span class="n">all_pos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pheno_mut</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="s2">&quot;WT&quot;</span><span class="p">]))</span>
        <span class="n">all_pos_mut</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">):[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pheno_mut</span> <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_pos</span><span class="p">}</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1">#Order at least 2</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">all_features</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">#All position combinations</span>
                <span class="n">pos_comb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">all_pos_mut</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">n</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos_comb</span><span class="p">:</span>
                    <span class="c1">#All mutation combinations for these positions</span>
                    <span class="n">all_features</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">all_pos_mut</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">p</span><span class="p">])]</span>
        <span class="k">return</span> <span class="n">all_features</span></div>


<div class="viewcode-block" id="MochiData.merge_dictionaries">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.merge_dictionaries">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_dictionaries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dict1</span><span class="p">,</span>
        <span class="n">dict2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merge two dictionaries by keys (and unique values).</span>

<span class="sd">        :param dict1: Dictionary 1.</span>
<span class="sd">        :param dict2: Dictionary 2.</span>
<span class="sd">        :returns: merged dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dict2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dict1</span><span class="p">:</span>
                <span class="n">dict1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dict1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">dict2</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dict1</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dict1</span></div>


<div class="viewcode-block" id="MochiData.get_theoretical_interactions">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.get_theoretical_interactions">[docs]</a>
    <span class="k">def</span> <span class="nf">get_theoretical_interactions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">max_order</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get theoretical interaction features.</span>

<span class="sd">        :param max_order: Maximum interaction order (default:2).</span>
<span class="sd">        :returns: tuple with dictionary of interaction features and dictionary of order counts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#All features</span>
        <span class="n">all_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="o">.</span><span class="n">phenotype</span><span class="p">):</span>
            <span class="n">all_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_dictionaries</span><span class="p">(</span>
                <span class="n">dict1</span> <span class="o">=</span> <span class="n">all_features</span><span class="p">,</span>
                <span class="n">dict2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_theoretical_interactions_phenotype</span><span class="p">(</span><span class="n">phenotype</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_order</span> <span class="o">=</span> <span class="n">max_order</span><span class="p">))</span>
        <span class="c1">#All feature orders</span>
        <span class="n">int_order_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_features</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">all_features</span><span class="p">,</span> <span class="n">int_order_dict</span><span class="p">)</span></div>


    <span class="c1"># def write_features(</span>
    <span class="c1">#     self,</span>
    <span class="c1">#     feature_list, </span>
    <span class="c1">#     feature_chunk_size,</span>
    <span class="c1">#     samples_chunk_size = 100,</span>
    <span class="c1">#     initial_chunk = False,</span>
    <span class="c1">#     final_chunk = False):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Write features to disk.</span>

    <span class="c1">#     :param feature_list: List of features.</span>
    <span class="c1">#     :param feature_chunk_size: Features chunk size in number of features.</span>
    <span class="c1">#     :param samples_chunk_size: Samples chunk size in number of samples (default:100).</span>
    <span class="c1">#     :param initial_chunk: Whether or not the supplied list is the initial chunk (default:False).</span>
    <span class="c1">#     :param final_chunk: Whether or not the supplied list is the final chunk (default:False).</span>
    <span class="c1">#     :returns: feature list.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     #Check if anything to write</span>
    <span class="c1">#     if len(feature_list)==feature_chunk_size or final_chunk or initial_chunk:</span>
    <span class="c1">#         write_df = pd.concat(feature_list, axis = 1)</span>
    <span class="c1">#         self.update_holdout_observations(write_df)</span>
    <span class="c1">#         write_df = write_df.transpose()</span>
    <span class="c1">#         write_count = 0</span>
    <span class="c1">#         #Write feature data in chunks of rows (transposed)</span>
    <span class="c1">#         while write_count &lt; write_df.shape[1]:</span>
    <span class="c1">#             write_file = os.path.join(self.directory, &#39;data_chunk&#39;+str(write_count)+&quot;.csv&quot;)</span>
    <span class="c1">#             write_df.iloc[:,list(range(write_count, min([write_count+samples_chunk_size, write_df.shape[1]])))].to_csv(</span>
    <span class="c1">#                 write_file, mode=&#39;a&#39;, index=False, header=False)</span>
    <span class="c1">#             write_count += samples_chunk_size</span>
    <span class="c1">#         #Reset list and index</span>
    <span class="c1">#         feature_list = []</span>
    <span class="c1">#     return feature_list</span>

    <span class="c1"># def transpose_features(</span>
    <span class="c1">#     self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Transpose features on disk.</span>

    <span class="c1">#     :returns: nothing.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     files = os.listdir(self.directory)</span>
    <span class="c1">#     for f in files:</span>
    <span class="c1">#         if f.startswith(&quot;data_chunk&quot;):</span>
    <span class="c1">#             pd.read_csv(</span>
    <span class="c1">#                 os.path.join(self.directory, f), header=None).transpose().to_csv(</span>
    <span class="c1">#                 os.path.join(self.directory, f), index=False, header=False)</span>

    <span class="c1"># def one_hot_encode_interactions_todisk(</span>
    <span class="c1">#     self, </span>
    <span class="c1">#     max_order = 2,</span>
    <span class="c1">#     max_cells = 1e9,</span>
    <span class="c1">#     min_observed = 2,</span>
    <span class="c1">#     features = [],</span>
    <span class="c1">#     downsample_interactions = None,</span>
    <span class="c1">#     seed = 1,</span>
    <span class="c1">#     chunk_size = 100,</span>
    <span class="c1">#     holdout_minobs = 0,</span>
    <span class="c1">#     holdout_orders = [],</span>
    <span class="c1">#     holdout_WT = False):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Add interaction terms to 1-hot encoding DataFrame.</span>

    <span class="c1">#     :param max_order: Maximum interaction order (default:2).</span>
    <span class="c1">#     :param max_cells: Maximum matrix cells permitted (default:1billion).</span>
    <span class="c1">#     :param min_observed: Minimum number of observations required to include interaction term (default:2).</span>
    <span class="c1">#     :param features: list of feature names to filter (default:[] i.e. all  features retained).</span>
    <span class="c1">#     :param downsample_interactions: number (if integer) or proportion (if float) or list of integer numbers (if string) of interaction terms to retain (optional).</span>
    <span class="c1">#     :param seed: Random seed for downsampling interactions (default:1).</span>
    <span class="c1">#     :param chunk_size: Number of features per file (default:100).</span>
    <span class="c1">#     :param holdout_minobs: Minimum number of observations of additive trait weights to be held out (default:0).</span>
    <span class="c1">#     :param holdout_orders: list of mutation orders corresponding to retained variants (default:[] i.e. variants of all mutation orders can be held out).</span>
    <span class="c1">#     :param holdout_WT: list of mutation orders corresponding to retained variants (default:False).</span>
    <span class="c1">#     :returns: Nothing.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     #First order interaction features</span>
    <span class="c1">#     #Filter features</span>
    <span class="c1">#     if features!=[]:</span>
    <span class="c1">#         print(&quot;Filtering features&quot;)</span>
    <span class="c1">#         self.Xoh = self.filter_features(</span>
    <span class="c1">#             input_df = self.Xoh,</span>
    <span class="c1">#             features = features)</span>
    <span class="c1">#     #Write to disk</span>
    <span class="c1">#     int_list = self.write_features(</span>
    <span class="c1">#         feature_list = [self.Xoh[i] for i in self.Xoh.columns], </span>
    <span class="c1">#         feature_chunk_size = chunk_size,</span>
    <span class="c1">#         initial_chunk = True)</span>
    <span class="c1">#     #Save feature names</span>
    <span class="c1">#     self.feature_names = list(self.Xoh.columns)</span>

    <span class="c1">#     #Check if no interactions to add</span>
    <span class="c1">#     if max_order&lt;2:</span>
    <span class="c1">#         #Transpose disk data in place</span>
    <span class="c1">#         print(&quot;Transposing features&quot;)</span>
    <span class="c1">#         self.transpose_features()</span>
    <span class="c1">#         return</span>

    <span class="c1">#     #Check downsample_interactions argument valid</span>
    <span class="c1">#     if downsample_interactions!=None:</span>
    <span class="c1">#         if type(downsample_interactions) == float:</span>
    <span class="c1">#             #Downsample observations by proportion</span>
    <span class="c1">#             if downsample_interactions &gt;= 1 or downsample_interactions &lt;= 0:</span>
    <span class="c1">#                 print(&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;)</span>
    <span class="c1">#                 raise ValueError</span>
    <span class="c1">#         elif type(downsample_interactions) == int:</span>
    <span class="c1">#             #Downsample observations by number</span>
    <span class="c1">#             if downsample_interactions &lt; 1:</span>
    <span class="c1">#                 print(&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;)</span>
    <span class="c1">#                 raise ValueError</span>
    <span class="c1">#         elif type(downsample_interactions) == str:</span>
    <span class="c1">#             try:</span>
    <span class="c1">#                 downsample_interactions = {(i+2):int(d) for i,d in enumerate(str(downsample_interactions).split(&quot;,&quot;))}</span>
    <span class="c1">#             except:</span>
    <span class="c1">#                 print(&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;)</span>
    <span class="c1">#                 raise ValueError</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             print(&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;)</span>
    <span class="c1">#             raise ValueError</span>

    <span class="c1">#     #Get all theoretical interactions</span>
    <span class="c1">#     all_features,int_order_dict = self.get_theoretical_interactions(max_order = max_order)</span>
    <span class="c1">#     print(&quot;... Total theoretical features (order:count): &quot;+&quot;, &quot;.join([str(i)+&quot;:&quot;+str(int_order_dict[i]) for i in sorted(int_order_dict.keys())]))</span>
    <span class="c1">#     #Flatten</span>
    <span class="c1">#     all_features_flat = list(itertools.chain(*list(all_features.values())))</span>

    <span class="c1">#     #Check if all interaction features exist (i.e. with mutation order&gt;1)</span>
    <span class="c1">#     if len([i for i in features if (i not in all_features_flat) and (len(i.split(&#39;_&#39;))&gt;1)]) != 0:</span>
    <span class="c1">#         print(&quot;Error: Invalid feature names.&quot;)</span>
    <span class="c1">#         raise ValueError</span>

    <span class="c1">#     #Select interactions</span>
    <span class="c1">#     int_list = []</span>
    <span class="c1">#     int_order_dict_retained = {}</span>
    <span class="c1">#     int_list_names = []</span>
    <span class="c1">#     #No shuffle if not downsampling</span>
    <span class="c1">#     if downsample_interactions is None:</span>
    <span class="c1">#         all_features_loop = {0: all_features_flat}</span>
    <span class="c1">#     #Shuffle flattened features</span>
    <span class="c1">#     elif type(downsample_interactions) in [float, int]:</span>
    <span class="c1">#         random.seed(seed)</span>
    <span class="c1">#         all_features_loop = {0: random.sample(all_features_flat, len(all_features_flat))}</span>
    <span class="c1">#     #Shuffle features separately per order</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         all_features_loop = {k: random.sample(all_features[k], len(all_features[k])) for k in all_features}</span>

    <span class="c1">#     #Loop over all orders</span>
    <span class="c1">#     for n in all_features_loop.keys():</span>
    <span class="c1">#         #Loop over all features of this order</span>
    <span class="c1">#         for c in all_features_loop[n]:</span>
    <span class="c1">#             c_split = c.split(&quot;_&quot;)</span>
    <span class="c1">#             #Check if feature desired</span>
    <span class="c1">#             if (c in features) or features==[]:</span>
    <span class="c1">#                 int_col = (self.Xoh.loc[:,c_split].sum(axis = 1)==len(c_split)).astype(int)</span>
    <span class="c1">#                 #Check if minimum number of observations satisfied</span>
    <span class="c1">#                 if sum(int_col) &gt;= min_observed:</span>
    <span class="c1">#                     int_list += [int_col]</span>
    <span class="c1">#                     int_list_names += [c]</span>
    <span class="c1">#                     if len(c_split) not in int_order_dict_retained.keys():</span>
    <span class="c1">#                         int_order_dict_retained[len(c_split)] = 1</span>
    <span class="c1">#                     else:</span>
    <span class="c1">#                         int_order_dict_retained[len(c_split)] += 1</span>
    <span class="c1">#                 # else:</span>
    <span class="c1">#                 #     if len(c_split)==3 and sum(int_col)==1:</span>
    <span class="c1">#                 #         print(c)</span>
    <span class="c1">#                 #Check memory footprint</span>
    <span class="c1">#                 if len(int_list_names)*len(self.Xoh) &gt; max_cells:</span>
    <span class="c1">#                     print(f&quot;Error: Too many interaction terms: number of feature matrix cells &gt;{max_cells:&gt;.0e}&quot;)</span>
    <span class="c1">#                     raise ValueError</span>
    <span class="c1">#                 #Check if sufficient features obtained</span>
    <span class="c1">#                 if type(downsample_interactions) == float:</span>
    <span class="c1">#                     if len(int_list_names) == int(len(all_features_flat)*downsample_interactions):</span>
    <span class="c1">#                         break</span>
    <span class="c1">#                 elif type(downsample_interactions) == int:</span>
    <span class="c1">#                     if len(int_list_names) == downsample_interactions:</span>
    <span class="c1">#                         break</span>
    <span class="c1">#                 elif type(downsample_interactions) == dict:</span>
    <span class="c1">#                     if len(c_split) in int_order_dict_retained.keys():</span>
    <span class="c1">#                         if int_order_dict_retained[len(c_split)] &gt; downsample_interactions[len(c_split)] and downsample_interactions[len(c_split)]!=(-1):</span>
    <span class="c1">#                             int_list.pop()</span>
    <span class="c1">#                             int_list_names.pop()</span>
    <span class="c1">#                             int_order_dict_retained[len(c_split)] -= 1</span>
    <span class="c1">#                             break</span>
    <span class="c1">#                         elif int_order_dict_retained == downsample_interactions:</span>
    <span class="c1">#                             break</span>
    <span class="c1">#                 #Write chunk to disk</span>
    <span class="c1">#                 int_list = self.write_features(</span>
    <span class="c1">#                     feature_list = int_list, </span>
    <span class="c1">#                     feature_chunk_size = chunk_size)</span>
    <span class="c1">#     #Write final chunk to disk</span>
    <span class="c1">#     int_list = self.write_features(</span>
    <span class="c1">#         feature_list = int_list, </span>
    <span class="c1">#         feature_chunk_size = chunk_size,</span>
    <span class="c1">#         final_chunk = True)</span>

    <span class="c1">#     print(&quot;... Total retained features (order:count): &quot;+&quot;, &quot;.join([str(i)+&quot;:&quot;+str(int_order_dict_retained[i])+&quot; (&quot;+str(round(int_order_dict_retained[i]/int_order_dict[i]*100, 1))+&quot;%)&quot; for i in sorted(int_order_dict_retained.keys())]))</span>

    <span class="c1">#     #Transpose disk data in place</span>
    <span class="c1">#     print(&quot;Transposing features&quot;)</span>
    <span class="c1">#     self.transpose_features()</span>

    <span class="c1">#     #Save interaction feature names</span>
    <span class="c1">#     self.feature_names += int_list_names</span>

<div class="viewcode-block" id="MochiData.one_hot_encode_interactions">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.one_hot_encode_interactions">[docs]</a>
    <span class="k">def</span> <span class="nf">one_hot_encode_interactions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">max_order</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">max_cells</span> <span class="o">=</span> <span class="mf">1e9</span><span class="p">,</span>
        <span class="n">min_observed</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">downsample_interactions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add interaction terms to 1-hot encoding DataFrame.</span>

<span class="sd">        :param max_order: Maximum interaction order (default:2).</span>
<span class="sd">        :param max_cells: Maximum matrix cells permitted (default:1billion).</span>
<span class="sd">        :param min_observed: Minimum number of observations required to include interaction term (default:2).</span>
<span class="sd">        :param features: list of feature names to filter (default:[] i.e. all  features retained).</span>
<span class="sd">        :param downsample_interactions: number (if integer) or proportion (if float) or list of integer numbers (if string) of interaction terms to retain (optional).</span>
<span class="sd">        :param seed: Random seed for downsampling interactions (default:1).</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Check if no interactions to add</span>
        <span class="k">if</span> <span class="n">max_order</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="p">)</span>
            <span class="c1">#Filter features</span>
            <span class="k">if</span> <span class="n">features</span><span class="o">!=</span><span class="p">[]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering features&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_features</span><span class="p">(</span>
                    <span class="n">input_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="p">,</span>
                    <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1">#Check downsample_interactions argument valid</span>
        <span class="k">if</span> <span class="n">downsample_interactions</span><span class="o">!=</span><span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                <span class="c1">#Downsample observations by proportion</span>
                <span class="k">if</span> <span class="n">downsample_interactions</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">downsample_interactions</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                <span class="c1">#Downsample observations by number</span>
                <span class="k">if</span> <span class="n">downsample_interactions</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">downsample_interactions</span> <span class="o">=</span> <span class="p">{(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))}</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: downsample_interactions argument invalid: only proportions in range (0,1) or positive integer numbers allowed.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1">#Get all theoretical interactions</span>
        <span class="n">all_features</span><span class="p">,</span><span class="n">int_order_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_theoretical_interactions</span><span class="p">(</span><span class="n">max_order</span> <span class="o">=</span> <span class="n">max_order</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Total theoretical features (order:count): &quot;</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">int_order_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">int_order_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())]))</span>
        <span class="c1">#Flatten</span>
        <span class="n">all_features_flat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="n">all_features</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>

        <span class="c1">#Check if all interaction features exist (i.e. with mutation order&gt;1)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_features_flat</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid feature names.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1">#Select interactions</span>
        <span class="n">int_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">int_order_dict_retained</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">int_list_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#No shuffle if not downsampling</span>
        <span class="k">if</span> <span class="n">downsample_interactions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_features_loop</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">all_features_flat</span><span class="p">}</span>
        <span class="c1">#Shuffle flattened features</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            <span class="n">all_features_loop</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_features_flat</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features_flat</span><span class="p">))}</span>
        <span class="c1">#Shuffle features separately per order</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_features_loop</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">all_features</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_features</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">all_features</span><span class="p">}</span>

        <span class="c1">#Loop over all orders</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_features_loop</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1">#Loop over all features of this order</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_features_loop</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
                <span class="n">c_split</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="c1">#Check if feature desired</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">features</span><span class="p">)</span> <span class="ow">or</span> <span class="n">features</span><span class="o">==</span><span class="p">[]:</span>
                    <span class="n">int_col</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">c_split</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="c1">#Check if minimum number of observations satisfied</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">int_col</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_observed</span><span class="p">:</span>
                        <span class="n">int_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">int_col</span><span class="p">]</span>
                        <span class="n">int_list_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">int_order_dict_retained</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">int_order_dict_retained</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">int_order_dict_retained</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     if len(c_split)==3 and sum(int_col)==1:</span>
                    <span class="c1">#         print(c)</span>
                    <span class="c1">#Check memory footprint</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_cells</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Too many interaction terms: number of feature matrix cells &gt;</span><span class="si">{</span><span class="n">max_cells</span><span class="si">:</span><span class="s2">&gt;.0e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span>
                    <span class="c1">#Check if sufficient features obtained</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">all_features_flat</span><span class="p">)</span><span class="o">*</span><span class="n">downsample_interactions</span><span class="p">):</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list</span><span class="p">)</span> <span class="o">==</span> <span class="n">downsample_interactions</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">downsample_interactions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)</span> <span class="ow">in</span> <span class="n">int_order_dict_retained</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">int_order_dict_retained</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="n">downsample_interactions</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)]</span> <span class="ow">and</span> <span class="n">downsample_interactions</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)]</span><span class="o">!=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">int_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                                <span class="n">int_list_names</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                                <span class="n">int_order_dict_retained</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c_split</span><span class="p">)]</span> <span class="o">-=</span> <span class="mi">1</span>
                                <span class="k">break</span>
                            <span class="k">elif</span> <span class="n">int_order_dict_retained</span> <span class="o">==</span> <span class="n">downsample_interactions</span><span class="p">:</span>
                                <span class="k">break</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;... Total retained features (order:count): &quot;</span><span class="o">+</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">int_order_dict_retained</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot; (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">int_order_dict_retained</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">int_order_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;%)&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">int_order_dict_retained</span><span class="o">.</span><span class="n">keys</span><span class="p">())]))</span>

        <span class="c1">#Concatenate into dataframe</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">int_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">int_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">int_list_names</span>
            <span class="c1">#Reorder</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_features_flat</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">columns</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="p">)</span>

        <span class="c1">#Filter features</span>
        <span class="k">if</span> <span class="n">features</span><span class="o">!=</span><span class="p">[]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Filtering features&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_features</span><span class="p">(</span>
                <span class="n">input_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="p">,</span>
                <span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">)</span>

        <span class="c1">#Save interaction feature names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">columns</span></div>


<div class="viewcode-block" id="MochiData.filter_features">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.filter_features">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">input_df</span><span class="p">,</span>
        <span class="n">features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter features by name.</span>

<span class="sd">        :param input_df: DataFrame of features to filter.</span>
<span class="sd">        :param features: list of feature names to filter (default:[] i.e. all features retained).</span>
<span class="sd">        :returns: filtered DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check if all features exist </span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">features</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">input_df</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid feature names.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Filter features</span>
        <span class="n">features_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">input_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">features</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">input_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">features_order</span><span class="p">]</span></div>


<div class="viewcode-block" id="MochiData.H_matrix">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.H_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">H_matrix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">str_geno</span><span class="p">,</span>
        <span class="n">str_coef</span><span class="p">,</span>
        <span class="n">num_states</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct Walsh-Hadamard matrix.</span>

<span class="sd">        :param str_geno: list of genotype strings where &#39;0&#39; indicates WT state.</span>
<span class="sd">        :param str_coef: list of coefficient strings where &#39;0&#39; indicates WT state.</span>
<span class="sd">        :param num_states: integer number of states (identical per position) or list of integers with length matching that of sequences.</span>
<span class="sd">        :param invert: invert the matrix.</span>
<span class="sd">        :returns: Walsh-Hadamard matrix as a numpy matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Genotype string length</span>
        <span class="n">string_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#Number of states per position in genotype string (float)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_states</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">num_states</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">num_states</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">string_length</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_states</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_states</span><span class="p">]</span>
        <span class="c1">#Convert reference characters to &quot;.&quot; and binary encode</span>
        <span class="n">str_coef</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">ord</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">str_coef</span><span class="p">]</span>
        <span class="n">str_geno</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">ord</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">str_geno</span><span class="p">]</span>
        <span class="c1">#Matrix representations</span>
        <span class="n">num_statesi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">num_states</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">str_coef</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">str_genobi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">str_geno</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_coef</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">str_coefbi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">str_coef</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">)))</span>
        <span class="n">str_genobi_eq_str_coefbi</span> <span class="o">=</span> <span class="p">(</span><span class="n">str_genobi</span> <span class="o">==</span> <span class="n">str_coefbi</span><span class="p">)</span>
        <span class="c1">#Factors</span>
        <span class="n">row_factor2</span> <span class="o">=</span> <span class="n">str_genobi_eq_str_coefbi</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">row_factor1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">str_genobi_eq_str_coefbi</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_statesi</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>       
            <span class="k">return</span> <span class="p">((</span><span class="n">row_factor1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_factor2</span><span class="p">))</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">num_states</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row_factor1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">str_genobi_eq_str_coefbi</span><span class="p">,</span> <span class="n">str_genobi</span><span class="o">==</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)),</span> <span class="n">str_coefbi</span><span class="o">==</span><span class="nb">ord</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">string_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>            
            <span class="k">return</span> <span class="p">((</span><span class="n">row_factor1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">row_factor2</span><span class="p">)))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="MochiData.H_matrix_chunker">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.H_matrix_chunker">[docs]</a>
    <span class="k">def</span> <span class="nf">H_matrix_chunker</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">str_geno</span><span class="p">,</span>
        <span class="n">str_coef</span><span class="p">,</span>
        <span class="n">num_states</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct Walsh-Hadamard matrix in chunks.</span>

<span class="sd">        :param str_geno: list of genotype strings where &#39;0&#39; indicates WT state.</span>
<span class="sd">        :param str_coef: list of coefficient strings where &#39;0&#39; indicates WT state.</span>
<span class="sd">        :param num_states: integer number of states (identical per position) or list of integers with length matching that of sequences.</span>
<span class="sd">        :param invert: invert the matrix.</span>
<span class="sd">        :param chunk_size: chunk size in number of genotypes/variants (default:1000).</span>
<span class="sd">        :returns: Walsh-Hadamard matrix as a numpy matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Check if chunking not necessary</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">chunk_size</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_matrix</span><span class="p">(</span>
                <span class="n">str_geno</span> <span class="o">=</span> <span class="n">str_geno</span><span class="p">,</span> 
                <span class="n">str_coef</span> <span class="o">=</span> <span class="n">str_coef</span><span class="p">,</span> 
                <span class="n">num_states</span> <span class="o">=</span> <span class="n">num_states</span><span class="p">,</span> 
                <span class="n">invert</span> <span class="o">=</span> <span class="n">invert</span><span class="p">)</span>

        <span class="c1">#Chunk</span>
        <span class="n">hmat_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">)</span><span class="o">/</span><span class="n">chunk_size</span><span class="p">)):</span>
            <span class="n">from_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">)</span>
            <span class="n">to_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_size</span>
            <span class="k">if</span> <span class="n">to_i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">):</span>
                <span class="n">to_i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">)</span>
            <span class="n">hmat_list</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">H_matrix</span><span class="p">(</span>
                <span class="n">str_geno</span> <span class="o">=</span> <span class="n">str_geno</span><span class="p">[</span><span class="n">from_i</span><span class="p">:</span><span class="n">to_i</span><span class="p">],</span> 
                <span class="n">str_coef</span> <span class="o">=</span> <span class="n">str_coef</span><span class="p">,</span> 
                <span class="n">num_states</span> <span class="o">=</span> <span class="n">num_states</span><span class="p">,</span> 
                <span class="n">invert</span> <span class="o">=</span> <span class="n">invert</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">hmat_list</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="MochiData.V_matrix">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.V_matrix">[docs]</a>
    <span class="k">def</span> <span class="nf">V_matrix</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">str_coef</span><span class="p">,</span>
        <span class="n">num_states</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct diagonal weighting matrix.</span>

<span class="sd">        :param str_coef: list of coefficient strings where &#39;0&#39; indicates WT state.</span>
<span class="sd">        :param num_states: integer number of states (identical per position) or list of integers with length matching that of sequences.</span>
<span class="sd">        :param invert: invert the matrix.</span>
<span class="sd">        :returns: diagonal weighting matrix as a numpy matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Genotype subset</span>
        <span class="n">str_geno</span> <span class="o">=</span> <span class="n">str_coef</span>
        <span class="c1">#Genotype string length</span>
        <span class="n">string_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#Number of states per position in genotype string</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">num_states</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">num_states</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">num_states</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">string_length</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_states</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">num_states</span><span class="p">]</span>
        <span class="c1">#Convert reference characters to &quot;.&quot;</span>
        <span class="n">str_coef_</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">str_coef</span><span class="p">]</span>
        <span class="c1">#initialize V matrix</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">str_coef</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">))</span>
        <span class="c1">#Fill matrix</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">str_geno</span><span class="p">)):</span>
            <span class="n">factor1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">str_coef_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">str_geno</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">num_states</span><span class="p">)</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)]))</span>
            <span class="n">factor2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">str_coef_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">str_geno</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">ord</span><span class="p">(</span><span class="n">b</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">factor1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">factor2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">factor1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">factor2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">V</span></div>


<div class="viewcode-block" id="MochiData.coefficient_to_sequence">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.coefficient_to_sequence">[docs]</a>
    <span class="k">def</span> <span class="nf">coefficient_to_sequence</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">coefficient</span><span class="p">,</span>
        <span class="n">length</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get sequence representation of a coefficient string.</span>

<span class="sd">        :param coefficient: coefficient string.</span>
<span class="sd">        :param length: integer sequence length.</span>
<span class="sd">        :returns: sequence string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#initialize sequence string</span>
        <span class="n">coefficient_seq</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">length</span>
        <span class="c1">#Wild-type sequence string</span>
        <span class="k">if</span> <span class="n">coefficient</span> <span class="o">==</span> <span class="s2">&quot;WT&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coefficient_seq</span><span class="p">)</span>
        <span class="c1">#Variant sequence string</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coefficient</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
            <span class="n">coefficient_seq</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coefficient_seq</span><span class="p">)</span></div>


<div class="viewcode-block" id="MochiData.ensemble_encode_features">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.ensemble_encode_features">[docs]</a>
    <span class="k">def</span> <span class="nf">ensemble_encode_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensemble encode features.</span>

<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Wild-type mask variant sequences</span>
        <span class="n">geno_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span> <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="n">y</span> <span class="k">else</span> <span class="s1">&#39;0&#39;</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">variantCol</span><span class="p">]),</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">wildtype</span><span class="p">)),</span>
            <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1">#Sequence representation of 1-hot encoded coefficients/features</span>
        <span class="n">ceof_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficient_to_sequence</span><span class="p">(</span><span class="n">coef</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">wildtype</span><span class="p">))</span> <span class="k">for</span> <span class="n">coef</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="c1">#Number of states per position</span>
        <span class="n">state_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">column</span><span class="p">:</span> <span class="n">column</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">column</span><span class="p">:</span> <span class="n">column</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">state_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">state_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1">#Ensemble encode features</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">hmat_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_matrix_chunker</span><span class="p">(</span>
            <span class="n">str_geno</span> <span class="o">=</span> <span class="n">geno_list</span><span class="p">,</span> 
            <span class="n">str_coef</span> <span class="o">=</span> <span class="n">ceof_list</span><span class="p">,</span> 
            <span class="n">num_states</span> <span class="o">=</span> <span class="n">state_list</span><span class="p">,</span> 
            <span class="n">invert</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Construction time for H_matrix :&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
        <span class="n">vmat_inv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_matrix</span><span class="p">(</span>
            <span class="n">str_coef</span> <span class="o">=</span> <span class="n">ceof_list</span><span class="p">,</span> 
            <span class="n">num_states</span> <span class="o">=</span> <span class="n">state_list</span><span class="p">,</span> 
            <span class="n">invert</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">hmat_inv</span><span class="p">,</span> <span class="n">vmat_inv</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></div>


<div class="viewcode-block" id="MochiData.update_holdout_observations">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.update_holdout_observations">[docs]</a>
    <span class="k">def</span> <span class="nf">update_holdout_observations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">input_df</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update holdout status for observations.</span>

<span class="sd">        :param input_df: DataFrame of features to use for update.</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Default: hold out all orders</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">holdout_orders</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">holdout_orders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">mutationOrderCol</span><span class="p">]))</span>

        <span class="c1">#Variants that can be held out (determined separately for each additive trait)</span>
        <span class="n">all_traits_unique</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;trait&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]))</span>
        <span class="c1">#Initialize holdout status (all variants can be held out)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;holdout&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">input_df</span><span class="p">))</span>
                <span class="p">})</span>
        <span class="c1">#Consider each additive trait separately</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_traits_unique</span><span class="p">:</span>
            <span class="c1">#Phenotypes reporting on this trait</span>
            <span class="n">relevant_phenotype_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;phenotype_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;phenotype&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">))</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;trait&#39;</span><span class="p">]]</span>
            <span class="c1">#Number of observations per coefficient</span>
            <span class="n">Xohp_colsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">input_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="c1">#Indices of coefficients that do not meet required threshold</span>
            <span class="n">Xohp_noholdout</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Xohp_colsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Xohp_colsum</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">holdout_minobs</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="c1">#Observations of coefficients that do not meet the required threshold</span>
            <span class="n">Xohp_noholdout_rowsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">Xohp_noholdout</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">#WT variants for these phenotypes</span>
            <span class="n">Xohp_WT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;WT&#39;</span><span class="p">])</span>
            <span class="c1">#Mutation orders for these phenotypes</span>
            <span class="n">Xohp_mutationOrder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">mutationOrderCol</span><span class="p">])</span>
            <span class="c1">#Current holdout status</span>
            <span class="n">current_status</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;holdout&#39;</span><span class="p">])</span>
            <span class="c1">#Holdout status for this additive trait</span>
            <span class="n">noholdout_minobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
            <span class="n">noholdout_orders</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xohp_mutationOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">holdout_orders</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
            <span class="n">noholdout_WT</span> <span class="o">=</span> <span class="p">[((</span><span class="n">Xohp_WT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">holdout_WT</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
            <span class="n">noholdout</span> <span class="o">=</span> <span class="p">[(</span><span class="n">noholdout_minobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">noholdout_orders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">noholdout_WT</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
            <span class="c1">#New holdout status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;holdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">int</span><span class="p">((</span><span class="n">current_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">noholdout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))])</span></div>

        
<div class="viewcode-block" id="MochiData.define_cross_validation_groups">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.define_cross_validation_groups">[docs]</a>
    <span class="k">def</span> <span class="nf">define_cross_validation_groups</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define cross-validation groups.</span>

<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#Define holdout observations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#Default: hold out all orders</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">holdout_orders</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">holdout_orders</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">mutationOrderCol</span><span class="p">]))</span>

            <span class="c1">#Variants that can be held out (determined separately for each additive trait)</span>
            <span class="n">all_traits_unique</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">[</span><span class="s1">&#39;trait&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]))</span>
            <span class="c1">#Initialize holdout status (all variants can be held out)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;holdout&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="p">))</span>
                <span class="p">})</span>
            <span class="c1">#Consider each additive trait separately</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_traits_unique</span><span class="p">:</span>
                <span class="c1">#Phenotypes reporting on this trait</span>
                <span class="n">relevant_phenotype_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;phenotype_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;phenotype&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="p">))</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_design</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;trait&#39;</span><span class="p">]]</span>
                <span class="c1">#Number of observations per coefficient</span>
                <span class="n">Xohp_colsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="c1">#Indices of coefficients that do not meet required threshold</span>
                <span class="n">Xohp_noholdout</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Xohp_colsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Xohp_colsum</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">holdout_minobs</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="c1">#Observations of coefficients that do not meet the required threshold</span>
                <span class="n">Xohp_noholdout_rowsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">Xohp_noholdout</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="c1">#WT variants for these phenotypes</span>
                <span class="n">Xohp_WT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;WT&#39;</span><span class="p">])</span>
                <span class="c1">#Mutation orders for these phenotypes</span>
                <span class="n">Xohp_mutationOrder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="o">.</span><span class="n">mutationOrderCol</span><span class="p">])</span>
                <span class="c1">#Current holdout status</span>
                <span class="n">current_status</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;holdout&#39;</span><span class="p">])</span>
                <span class="c1">#Holdout status for this additive trait</span>
                <span class="n">noholdout_minobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
                <span class="n">noholdout_orders</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xohp_mutationOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">holdout_orders</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
                <span class="n">noholdout_WT</span> <span class="o">=</span> <span class="p">[((</span><span class="n">Xohp_WT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">holdout_WT</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
                <span class="n">noholdout</span> <span class="o">=</span> <span class="p">[(</span><span class="n">noholdout_minobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">noholdout_orders</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">noholdout_WT</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))]</span>
                <span class="c1">#New holdout status</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">relevant_phenotype_columns</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;holdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">int</span><span class="p">((</span><span class="n">current_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">noholdout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Xohp_noholdout_rowsum</span><span class="p">))])</span>
        
        <span class="c1">#Total number of variants that can be held out</span>
        <span class="n">n_holdout</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">holdout</span><span class="p">)</span>

        <span class="c1">#Hold out folds</span>
        <span class="n">holdout_fold</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_folds</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n_holdout</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">k_folds</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))[:</span><span class="n">n_holdout</span><span class="p">]</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">holdout_fold</span><span class="p">)</span>

        <span class="c1">#Add to cvgroups DataFrame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">holdout</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">holdout_fold</span>

        <span class="c1">#Add cross validation groups</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_folds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="s1">&#39;fold_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;training&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="s1">&#39;fold_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
            <span class="n">val_groups</span> <span class="o">=</span> <span class="p">[(</span><span class="n">j</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">k_folds</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">validation_factor</span><span class="p">))]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">val_groups</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="s1">&#39;fold&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">j</span><span class="p">,</span><span class="s1">&#39;fold_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;validation&quot;</span></div>


<div class="viewcode-block" id="MochiData.define_coefficient_groups">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.define_coefficient_groups">[docs]</a>
    <span class="k">def</span> <span class="nf">define_coefficient_groups</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">k_folds</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define coefficient groups.</span>

<span class="sd">        :param k_folds: Number of cross-validation folds (default:10).</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Cefficients that can be fit (for each phenotype and fold)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="c1"># self.coefficients[p] = pd.DataFrame({&#39;id&#39;: list(self.Xohi.columns)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_folds</span><span class="p">):</span>
                <span class="n">Xohp_colsum</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="s1">&#39;fold_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">==</span><span class="s2">&quot;training&quot;</span><span class="p">),:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;fold_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">Xohp_colsum</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])])</span>

        <span class="c1">#Coefficients specified to be fit (for each additive trait)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_userspec</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">)):</span>
            <span class="n">tcol</span> <span class="o">=</span> <span class="s2">&quot;additive_trait_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_trait</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_userspec</span><span class="p">[</span><span class="n">tcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_trait</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">[</span><span class="n">t</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_userspec</span><span class="p">[</span><span class="n">tcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span></div>


<div class="viewcode-block" id="MochiData.is_valid_instance">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.is_valid_instance">[docs]</a>
    <span class="k">def</span> <span class="nf">is_valid_instance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check object is valid instance.</span>

<span class="sd">        :returns: bool.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">not_none</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phenotype_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xoh</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coefficients_userspec</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">not_none</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="MochiData.get_data">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.get_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">fold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">training_resample</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data for a specified cross-validation fold.</span>

<span class="sd">        :param fold: Cross-validation fold (default:1).</span>
<span class="sd">        :param seed: Random seed for both training target data resampling and shuffling training data (default:1).</span>
<span class="sd">        :param training_resample: Whether or not to add random noise to training target data proportional to target error (default:True).</span>
<span class="sd">        :returns: Dictionary of dictionaries of tensors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Check for fitness data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_valid_instance</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Invalid MochiData instance.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="c1">#Loop over training, validation and test sets</span>
        <span class="n">fold_name</span> <span class="o">=</span> <span class="s2">&quot;fold_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fold</span><span class="p">)</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="n">fold_name</span><span class="p">])):</span>
            <span class="c1">#Shuffle indices for training data</span>
            <span class="n">sind</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="n">fold_name</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">==</span><span class="s2">&quot;training&quot;</span><span class="p">:</span>
                <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">+</span><span class="n">fold</span><span class="o">*</span><span class="mi">1000000</span><span class="p">)</span>
                <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">sind</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1">#Select tensor</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="n">fold_name</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">,:])</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;select&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sind</span><span class="p">,:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1">#Mask tensor (n_pheno x n_coef)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span><span class="p">[</span><span class="s2">&quot;phenotype_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">fold_name</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients</span><span class="p">))],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1">#Mask tensor - expand along trait axis (n_trait x n_pheno x n_coef)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additive_trait_names</span><span class="p">),</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="c1">#Mask tensor - coefficients specified to be fit (n_trait x n_pheno x n_coef)</span>
            <span class="n">mask_us</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coefficients_userspec</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mask_us</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mask_us</span><span class="p">,</span> <span class="p">(</span><span class="n">mask_us</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="n">mask_us</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mask_us</span>
            <span class="c1">#Feature tensor</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="n">fold_name</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">,:])</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sind</span><span class="p">,:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="c1">#Target tensor</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="n">fold_name</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">,</span><span class="s1">&#39;fitness&#39;</span><span class="p">])</span>
            <span class="c1">#Add random noise to training target data proportional to target error (if specified)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">==</span><span class="s2">&quot;training&quot;</span> <span class="ow">and</span> <span class="n">training_resample</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">+</span><span class="n">fold</span><span class="o">*</span><span class="mi">1000000</span><span class="p">)</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="s1">&#39;noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="n">fold_name</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">,</span><span class="s1">&#39;sigma&#39;</span><span class="p">])]</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sind</span><span class="p">,:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1">#Target weight tensor</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cvgroups</span><span class="p">[</span><span class="n">fold_name</span><span class="p">]</span><span class="o">==</span><span class="n">g</span><span class="p">,</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y_wt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y_wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="n">g</span><span class="p">][</span><span class="s1">&#39;y_wt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sind</span><span class="p">,:]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data_dict</span></div>


<div class="viewcode-block" id="MochiData.get_data_index">
<a class="viewcode-back" href="../../api.html#pymochi.data.MochiData.get_data_index">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data_index</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data corresponding to specific variants (by index).</span>

<span class="sd">        :param indices: Variant/observation indices (default:None i.e. all indices).</span>
<span class="sd">        :returns: Dictionary of dictionary of tensors (select, feature and target tensors only).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Set to all indices if empty list</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#Select tensor</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phenotypes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">indices</span><span class="p">,:])</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;select&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1">#Feature tensor</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xohi</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">indices</span><span class="p">,:])</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1">#Target tensor</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitness</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">indices</span><span class="p">,:][</span><span class="s1">&#39;fitness&#39;</span><span class="p">])</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data_dict</span></div>


    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Length of object.</span>
<span class="sd">        :returns: Number of variants (length of fdata).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fdata</span><span class="p">)</span></div>


<span class="c1"># class MochiDataset(Dataset):</span>
<span class="c1">#     def __init__(</span>
<span class="c1">#         self, </span>
<span class="c1">#         root, </span>
<span class="c1">#         data,</span>
<span class="c1">#         dataset_type = &#39;training&#39;, </span>
<span class="c1">#         fold = 1, </span>
<span class="c1">#         seed = 1,</span>
<span class="c1">#         training_resample = True,</span>
<span class="c1">#         transform = None):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Initialize a MochiDataset object.</span>

<span class="c1">#         :param root: Path to data directory (required).</span>
<span class="c1">#         :param data: An instance of the MochiData class (required).</span>
<span class="c1">#         :param dataset_type: One of &#39;training&#39;, &#39;validation&#39;, &#39;test&#39; (default:&#39;training&#39;).</span>
<span class="c1">#         :param fold: Cross-validation fold (default:1).</span>
<span class="c1">#         :param seed: Random seed for both training target data resampling and shuffling training data (default:1).</span>
<span class="c1">#         :param training_resample: Whether or not to add random noise to training target data proportional to target error (default:True).</span>
<span class="c1">#         :param transform: Transform to apply to feature data (default:None).</span>
<span class="c1">#         :returns: MochiTask object.</span>
<span class="c1">#         &quot;&quot;&quot; </span>
<span class="c1">#         self.root = root</span>
<span class="c1">#         self.data = data</span>
<span class="c1">#         self.dataset_type = dataset_type</span>
<span class="c1">#         self.fold_name = &quot;fold_&quot;+str(fold)</span>
<span class="c1">#         self.seed = seed</span>
<span class="c1">#         self.training_resample = training_resample</span>
<span class="c1">#         self.transform = transform</span>
<span class="c1">#         idx_list = list(self.data.cvgroups.loc[self.data.cvgroups[self.fold_name]==self.dataset_type,:].index)</span>
<span class="c1">#         self.idx_dict = {i:idx_list[i] for i in range(len(idx_list))}</span>

<span class="c1">#         #Target data</span>
<span class="c1">#         self.y = pd.DataFrame(self.data.fitness.loc[self.data.cvgroups[self.fold_name]==self.dataset_type,&#39;fitness&#39;])</span>
<span class="c1">#         #Add random noise to training target data proportional to target error (if specified)</span>
<span class="c1">#         if self.dataset_type==&quot;training&quot; and self.training_resample:</span>
<span class="c1">#             np.random.seed(self.seed)</span>
<span class="c1">#             self.y[&#39;noise&#39;] = [np.random.normal(scale = i) for i in list(self.data.fitness.loc[self.data.cvgroups[self.fold_name]==self.dataset_type,&#39;sigma&#39;])]</span>
<span class="c1">#             self.y[&#39;y&#39;] = pd.DataFrame(self.y.sum(axis = 1))</span>

<span class="c1">#     def __getitem__(self, idx):</span>
<span class="c1">#         #Observation</span>
<span class="c1">#         obs_number = self.idx_dict[idx]</span>

<span class="c1">#         #Feature tensor</span>
<span class="c1">#         file_name = &quot;data_chunk&quot;+str(obs_number - obs_number % 100)+&quot;.csv&quot;</span>
<span class="c1">#         line_number = obs_number % 100</span>
<span class="c1">#         line = linecache.getline(os.path.join(self.root, file_name), line_number)</span>
<span class="c1">#         csv_line = csv.reader([line])</span>
<span class="c1">#         X = torch.tensor(np.asarray([int(x) for x in next(csv_line)]), dtype=torch.float32)</span>

<span class="c1">#         #Target tensor</span>
<span class="c1">#         y = self.y.loc[obs_number,&#39;fitness&#39;]</span>
<span class="c1">#         y = torch.reshape(torch.tensor(np.asarray(y), dtype=torch.float32), (-1, 1))</span>

<span class="c1">#         return X,y</span>

<span class="c1">#     def __len__(self):</span>
<span class="c1">#         return len(self.idx_dict)</span>

<span class="c1"># class CustomImageDataset(Dataset):</span>
<span class="c1">#     def __init__(self, annotations_file, img_dir, transform=None, target_transform=None):</span>
<span class="c1">#         self.img_labels = pd.read_csv(annotations_file)</span>
<span class="c1">#         self.img_dir = img_dir</span>
<span class="c1">#         self.transform = transform</span>
<span class="c1">#         self.target_transform = target_transform</span>

<span class="c1">#     def __len__(self):</span>
<span class="c1">#         return len(self.img_labels)</span>

<span class="c1">#     def __getitem__(self, idx):</span>
<span class="c1">#         img_path = os.path.join(self.img_dir, self.img_labels.iloc[idx, 0])</span>
<span class="c1">#         image = read_image(img_path)</span>
<span class="c1">#         label = self.img_labels.iloc[idx, 1]</span>
<span class="c1">#         if self.transform:</span>
<span class="c1">#             image = self.transform(image)</span>
<span class="c1">#         if self.target_transform:</span>
<span class="c1">#             label = self.target_transform(label)</span>
<span class="c1">#         return image, label</span>
        
<div class="viewcode-block" id="FastTensorDataLoader">
<a class="viewcode-back" href="../../api.html#pymochi.data.FastTensorDataLoader">[docs]</a>
<span class="k">class</span> <span class="nc">FastTensorDataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A DataLoader-like object for a set of tensors that can be much faster than</span>
<span class="sd">    TensorDataset + DataLoader because dataloader grabs individual indices of</span>
<span class="sd">    the dataset and calls cat (slow).</span>
<span class="sd">    Source: https://discuss.pytorch.org/t/dataloader-much-slower-than-manual-batching/27014/6</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="o">*</span><span class="n">tensors</span><span class="p">,</span> 
        <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> 
        <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a FastTensorDataLoader.</span>

<span class="sd">        :param *tensors: tensors to store. Must have the same length @ dim 0.</span>
<span class="sd">        :param batch_size: batch size to load.</span>
<span class="sd">        :param shuffle: if True, shuffle the data *in-place* whenever an</span>
<span class="sd">            iterator is created out of this object.</span>
<span class="sd">        :returns: FastTensorDataLoader object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span> <span class="o">=</span> <span class="n">tensors</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>

        <span class="c1"># Calculate # batches</span>
        <span class="n">n_batches</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">remainder</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n_batches</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span> <span class="o">=</span> <span class="n">n_batches</span>
    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_len</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">return</span> <span class="n">batch</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_batches</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Andre J Faure. Project structure based on the Computational Molecular Science Python Cookiecutter version 1.6.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>